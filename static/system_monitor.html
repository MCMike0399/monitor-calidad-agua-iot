<!DOCTYPE html>
<html lang="es">
   <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <title>üîç Monitor de Sistema Distribuido - IoT Water Monitor</title>
      <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
      <style>
         * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
         }
         body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            background: #0f0f23;
            color: #cccccc;
            min-height: 100vh;
         }
         .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            text-align: center;
            color: white;
            position: relative;
         }
         .back-btn {
            position: absolute;
            left: 20px;
            top: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
         }
         .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            color: white;
         }
         .dashboard {
            padding: 20px;
            max-width: 1600px;
            margin: 0 auto;
         }
         .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
         }
         .grid-full {
            grid-column: 1 / -1;
         }
         .card {
            background: #1a1a2e;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #333;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
         }
         .card h3 {
            color: #4ade80;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
         }
         .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
         }
         .metric-item {
            background: #0f0f23;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #333;
         }
         .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #4ade80;
            margin: 5px 0;
         }
         .metric-label {
            font-size: 12px;
            opacity: 0.7;
         }
         .event-log {
            background: #0f0f23;
            height: 300px;
            overflow-y: auto;
            padding: 10px;
            font-family: "Courier New", monospace;
            font-size: 12px;
            border-radius: 8px;
            border: 1px solid #333;
         }
         .event-item {
            padding: 5px;
            margin: 2px 0;
            border-radius: 4px;
            display: flex;
            align-items: center;
            border-left: 3px solid #4ade80;
         }
         .event-time {
            color: #60a5fa;
            margin-right: 10px;
            min-width: 80px;
         }
         .event-source {
            color: #fbbf24;
            margin-right: 10px;
            min-width: 120px;
         }
         .event-details {
            color: #cccccc;
         }
         .chart-container {
            height: 300px;
            background: #0f0f23;
            border-radius: 8px;
            border: 1px solid #333;
         }
         .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
         }
         .online {
            background: #4ade80;
         }
         .offline {
            background: #f87171;
         }
         @keyframes pulse {
            0%,
            100% {
               opacity: 1;
            }
            50% {
               opacity: 0.5;
            }
         }
         .controls {
            margin: 15px 0;
         }
         .btn {
            background: #4ade80;
            color: #0f0f23;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            font-size: 12px;
         }
         .btn:hover {
            background: #22c55e;
         }
         .topology {
            background: #0f0f23;
            height: 350px;
            border-radius: 8px;
            border: 1px solid #333;
            position: relative;
            overflow: hidden;
         }
         .node {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 11px;
            text-align: center;
            position: absolute;
            border: 3px solid;
            transition: all 0.3s ease;
            z-index: 10;
         }
         .node.active {
            box-shadow: 0 0 20px rgba(74, 222, 128, 0.6);
            animation: nodeGlow 2s infinite;
         }
         @keyframes nodeGlow {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
         }
         .arduino-node {
            background: #f97316;
            border-color: #ea580c;
            top: 30px;
            left: 50px;
         }
         .server-node {
            background: #8b5cf6;
            border-color: #7c3aed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
         }
         .client-node {
            background: #06b6d4;
            border-color: #0891b2;
            top: 30px;
            right: 80px;
         }
         .admin-node {
            background: #ef4444;
            border-color: #dc2626;
            bottom: 30px;
            left: 80px;
         }
         .monitor-node {
            background: #10b981;
            border-color: #059669;
            bottom: 30px;
            right: 50px;
         }
         .connection-line {
            position: absolute;
            height: 3px;
            background: linear-gradient(90deg, #4ade80, #06b6d4);
            transform-origin: left center;
            opacity: 0;
            transition: opacity 0.5s ease;
            z-index: 5;
            border-radius: 1px;
            box-shadow: 0 0 10px rgba(74, 222, 128, 0.5);
         }
         .connection-line.active {
            opacity: 0.8;
            animation: dataFlow 2s infinite;
         }
         @keyframes dataFlow {
            0% { box-shadow: 0 0 10px rgba(74, 222, 128, 0.5); }
            50% { box-shadow: 0 0 20px rgba(74, 222, 128, 0.8); }
            100% { box-shadow: 0 0 10px rgba(74, 222, 128, 0.5); }
         }
         .connection-info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 15;
         }
         .connection-counter {
            margin: 2px 0;
         }
         .active-counter {
            color: #4ade80;
         }
         .inactive-counter {
            color: #f87171;
         }
         @media (max-width: 1200px) {
            .grid {
               grid-template-columns: 1fr;
            }
            .back-btn {
               position: static;
               margin-bottom: 15px;
               width: fit-content;
            }
         }
      </style>
   </head>
   <body>
      <div class="header">
         <a href="/" class="back-btn">
            <span>‚Üê</span>
            <span>Men√∫ Principal</span>
         </a>
         <h1>üîç Monitor de Sistema Distribuido</h1>
         <p>Visualizaci√≥n en Tiempo Real de Comunicaci√≥n IoT - Arduino + FastAPI + WebSockets</p>
         <div>
            <span id="connectionStatus" class="status-indicator offline"></span>
            <span id="connectionText">Conectando al sistema...</span>
         </div>
      </div>

      <div class="dashboard">
         <div class="grid">
            <!-- M√©tricas del Sistema -->
            <div class="card">
               <h3>üìä M√©tricas del Sistema</h3>
               <div class="metric-grid" id="metricsGrid">
                  <div class="metric-item">
                     <div class="metric-label">CPU</div>
                     <div id="cpuMetric" class="metric-value">--</div>
                     <div class="metric-label">%</div>
                  </div>
                  <div class="metric-item">
                     <div class="metric-label">Memoria</div>
                     <div id="memoryMetric" class="metric-value">--</div>
                     <div class="metric-label">%</div>
                  </div>
                  <div class="metric-item">
                     <div class="metric-label">Conexiones</div>
                     <div id="connectionsMetric" class="metric-value">--</div>
                     <div class="metric-label">activas</div>
                  </div>
                  <div class="metric-item">
                     <div class="metric-label">Eventos/seg</div>
                     <div id="eventsPerSecMetric" class="metric-value">--</div>
                     <div class="metric-label">eps</div>
                  </div>
               </div>
            </div>

            <!-- Topolog√≠a de Red -->
            <div class="card">
               <h3>üåê Topolog√≠a del Sistema</h3>
               <div class="topology" id="networkTopology">
                  <!-- Informaci√≥n de conexiones -->
                  <div class="connection-info">
                     <div class="connection-counter">
                        <span>üü¢ Monitor Clients: </span>
                        <span id="monitorClientCount" class="active-counter">0</span>
                     </div>
                     <div class="connection-counter">
                        <span>üî¥ Admin Clients: </span>
                        <span id="adminClientCount" class="active-counter">0</span>
                     </div>
                     <div class="connection-counter">
                        <span>üì° Arduino: </span>
                        <span id="arduinoStatus" class="inactive-counter">Desconectado</span>
                     </div>
                  </div>

                  <!-- Nodos del sistema -->
                  <div class="node arduino-node" id="arduinoNode" title="Arduino Uno R4 WiFi">Arduino<br />Sensores</div>
                  <div class="node server-node active" id="serverNode" title="Servidor FastAPI">FastAPI<br />Server</div>
                  <div class="node client-node" id="clientNode" title="Cliente Web">Web<br />Clients</div>
                  <div class="node admin-node" id="adminNode" title="Panel Admin">Admin<br />Panel</div>
                  <div class="node monitor-node active" id="monitorNodeVis" title="System Monitor">System<br />Monitor</div>

                  <!-- L√≠neas de conexi√≥n -->
                  <div class="connection-line" id="arduinoToServer"></div>
                  <div class="connection-line" id="serverToClient"></div>
                  <div class="connection-line" id="serverToAdmin"></div>
                  <div class="connection-line" id="serverToMonitor"></div>
               </div>
            </div>
         </div>

         <!-- Gr√°ficos de Performance -->
         <div class="grid">
            <div class="card">
               <h3>üìà CPU y Memoria</h3>
               <div class="chart-container" id="performanceChart"></div>
            </div>
            <div class="card">
               <h3>üì° Tr√°fico de Red</h3>
               <div class="chart-container" id="networkChart"></div>
            </div>
         </div>

         <!-- Estad√≠sticas de Comunicaci√≥n -->
         <div class="card grid-full">
            <h3>üìä Estad√≠sticas de Comunicaci√≥n</h3>
            <div class="metric-grid">
               <div class="metric-item">
                  <div class="metric-label">Total Conexiones</div>
                  <div id="totalConnections" class="metric-value">0</div>
               </div>
               <div class="metric-item">
                  <div class="metric-label">Total Desconexiones</div>
                  <div id="totalDisconnections" class="metric-value">0</div>
               </div>
               <div class="metric-item">
                  <div class="metric-label">Mensajes de Datos</div>
                  <div id="totalDataMessages" class="metric-value">0</div>
               </div>
               <div class="metric-item">
                  <div class="metric-label">Errores</div>
                  <div id="totalErrors" class="metric-value">0</div>
               </div>
               <div class="metric-item">
                  <div class="metric-label">Bytes Enviados</div>
                  <div id="bytesSent" class="metric-value">0</div>
               </div>
               <div class="metric-item">
                  <div class="metric-label">Bytes Recibidos</div>
                  <div id="bytesReceived" class="metric-value">0</div>
               </div>
            </div>
         </div>

         <!-- Log de Eventos -->
         <div class="card grid-full">
            <h3>üìù Log de Eventos en Tiempo Real</h3>
            <div class="controls">
               <button class="btn" onclick="clearEventLog()">üóëÔ∏è Limpiar Log</button>
               <button class="btn" onclick="requestFullHistory()">üìú Historial Completo</button>
               <label style="color: #cccccc"> <input type="checkbox" id="autoScroll" checked /> Auto-scroll </label>
            </div>
            <div class="event-log" id="eventLog">
               <div class="event-item">
                  <span class="event-time">--:--:--</span>
                  <span class="event-source">SYSTEM</span>
                  <span class="event-details">Conectando al monitor de sistema...</span>
               </div>
            </div>
         </div>
      </div>

      <script>
         let socket = null;
         let performanceData = { time: [], cpu: [], memory: [] };
         let networkData = { time: [], bytesIn: [], bytesOut: [] };
         let connectionStates = {
            arduino: false,
            monitorClients: 0,
            adminClients: 0
         };

         function connectWebSocket() {
            const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
            const wsUrl = `${protocol}//${window.location.host}/system-monitor/ws`;

            socket = new WebSocket(wsUrl);

            socket.onopen = function () {
               document.getElementById("connectionStatus").className = "status-indicator online";
               document.getElementById("connectionText").textContent = "Conectado al monitor";
               addEventToLog("SYSTEM", "Monitor conectado exitosamente", "connection");
               updateTopologyConnections();
            };

            socket.onmessage = function (event) {
               const data = JSON.parse(event.data);

               if (data.type === "initial_state") {
                  handleInitialState(data);
               } else if (data.type === "system_event") {
                  handleSystemEvent(data.event);
               } else if (data.type === "system_metrics") {
                  handleSystemMetrics(data);
               } else if (data.type === "full_history") {
                  handleFullHistory(data);
               }
            };

            socket.onclose = function () {
               document.getElementById("connectionStatus").className = "status-indicator offline";
               document.getElementById("connectionText").textContent = "Desconectado - Reconectando...";
               addEventToLog("SYSTEM", "Conexi√≥n perdida, reconectando...", "error");
               setTimeout(connectWebSocket, 3000);
            };

            socket.onerror = function (error) {
               addEventToLog("SYSTEM", "Error de conexi√≥n WebSocket", "error");
            };
         }

         function handleInitialState(data) {
            if (data.counters) updateCounters(data.counters);
            if (data.recent_events) {
               data.recent_events.forEach((event) => {
                  addEventToLog(event.source, JSON.stringify(event.details), event.event_type);
               });
            }
            if (data.metrics_history) {
               data.metrics_history.forEach((metric) => updateCharts(metric));
            }
            addEventToLog("SYSTEM", "Estado inicial cargado", "connection");
            updateTopologyConnections();
         }

         function handleSystemEvent(event) {
            addEventToLog(event.source, JSON.stringify(event.details), event.event_type);
            
            // Actualizar estados de conexi√≥n basados en eventos
            if (event.event_type === "connection") {
               if (event.source.includes("websocket_monitor_websocket")) {
                  connectionStates.monitorClients++;
               } else if (event.source.includes("admin")) {
                  connectionStates.adminClients++;
               } else if (event.details.endpoint === "arduino_http_route") {
                  connectionStates.arduino = true;
               }
            } else if (event.event_type === "disconnection") {
               if (event.source.includes("websocket_monitor_websocket")) {
                  connectionStates.monitorClients = Math.max(0, connectionStates.monitorClients - 1);
               } else if (event.source.includes("admin")) {
                  connectionStates.adminClients = Math.max(0, connectionStates.adminClients - 1);
               }
            }
            
            updateTopologyConnections();
         }

         function handleSystemMetrics(data) {
            if (data.metrics) {
               document.getElementById("cpuMetric").textContent = data.metrics.cpu_percent;
               document.getElementById("memoryMetric").textContent = data.metrics.memory_percent;
               document.getElementById("connectionsMetric").textContent = data.metrics.active_connections;
               document.getElementById("eventsPerSecMetric").textContent = data.metrics.events_per_second;
               updateCharts(data.metrics);
               
               // Actualizar conexiones desde m√©tricas
               connectionStates.monitorClients = data.metrics.active_connections;
            }
            if (data.counters) updateCounters(data.counters);
            updateTopologyConnections();
         }

         function updateTopologyConnections() {
            // Actualizar contadores en la interfaz
            document.getElementById("monitorClientCount").textContent = connectionStates.monitorClients;
            document.getElementById("adminClientCount").textContent = connectionStates.adminClients;
            document.getElementById("arduinoStatus").textContent = connectionStates.arduino ? "Conectado" : "Desconectado";
            document.getElementById("arduinoStatus").className = connectionStates.arduino ? "active-counter" : "inactive-counter";

            // Actualizar nodos
            updateNodeState("arduinoNode", connectionStates.arduino);
            updateNodeState("clientNode", connectionStates.monitorClients > 0);
            updateNodeState("adminNode", connectionStates.adminClients > 0);

            // Actualizar l√≠neas de conexi√≥n
            updateConnectionLine("arduinoToServer", connectionStates.arduino);
            updateConnectionLine("serverToClient", connectionStates.monitorClients > 0);
            updateConnectionLine("serverToAdmin", connectionStates.adminClients > 0);
            updateConnectionLine("serverToMonitor", true); // Siempre activo mientras estemos conectados

            // Calcular y mostrar l√≠neas
            calculateConnectionLines();
         }

         function updateNodeState(nodeId, isActive) {
            const node = document.getElementById(nodeId);
            if (isActive) {
               node.classList.add("active");
            } else {
               node.classList.remove("active");
            }
         }

         function updateConnectionLine(lineId, isActive) {
            const line = document.getElementById(lineId);
            if (isActive) {
               line.classList.add("active");
            } else {
               line.classList.remove("active");
            }
         }

         function calculateConnectionLines() {
            const server = document.getElementById("serverNode");
            const arduino = document.getElementById("arduinoNode");
            const client = document.getElementById("clientNode");
            const admin = document.getElementById("adminNode");
            const monitor = document.getElementById("monitorNodeVis");

            const serverRect = server.getBoundingClientRect();
            const topologyRect = document.getElementById("networkTopology").getBoundingClientRect();

            // Arduino to Server
            if (connectionStates.arduino) {
               const arduinoRect = arduino.getBoundingClientRect();
               drawConnectionLine("arduinoToServer", arduinoRect, serverRect, topologyRect);
            }

            // Server to Client
            if (connectionStates.monitorClients > 0) {
               const clientRect = client.getBoundingClientRect();
               drawConnectionLine("serverToClient", serverRect, clientRect, topologyRect);
            }

            // Server to Admin
            if (connectionStates.adminClients > 0) {
               const adminRect = admin.getBoundingClientRect();
               drawConnectionLine("serverToAdmin", serverRect, adminRect, topologyRect);
            }

            // Server to Monitor (always active)
            const monitorRect = monitor.getBoundingClientRect();
            drawConnectionLine("serverToMonitor", serverRect, monitorRect, topologyRect);
         }

         function drawConnectionLine(lineId, fromRect, toRect, containerRect) {
            const line = document.getElementById(lineId);
            
            const fromX = fromRect.left - containerRect.left + fromRect.width / 2;
            const fromY = fromRect.top - containerRect.top + fromRect.height / 2;
            const toX = toRect.left - containerRect.left + toRect.width / 2;
            const toY = toRect.top - containerRect.top + toRect.height / 2;
            
            const deltaX = toX - fromX;
            const deltaY = toY - fromY;
            const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
            const angle = Math.atan2(deltaY, deltaX) * 180 / Math.PI;
            
            line.style.left = fromX + "px";
            line.style.top = fromY + "px";
            line.style.width = distance + "px";
            line.style.transform = `rotate(${angle}deg)`;
         }

         function updateCounters(counters) {
            document.getElementById("totalConnections").textContent = counters.total_connections;
            document.getElementById("totalDisconnections").textContent = counters.total_disconnections;
            document.getElementById("totalDataMessages").textContent = counters.total_data_messages;
            document.getElementById("totalErrors").textContent = counters.total_errors;
            document.getElementById("bytesSent").textContent = formatBytes(counters.bytes_sent);
            document.getElementById("bytesReceived").textContent = formatBytes(counters.bytes_received);
         }

         function updateCharts(metrics) {
            const time = new Date(metrics.timestamp).toLocaleTimeString();

            performanceData.time.push(time);
            performanceData.cpu.push(metrics.cpu_percent);
            performanceData.memory.push(metrics.memory_percent);

            if (performanceData.time.length > 50) {
               performanceData.time.shift();
               performanceData.cpu.shift();
               performanceData.memory.shift();
            }

            Plotly.react(
               "performanceChart",
               [
                  {
                     x: performanceData.time,
                     y: performanceData.cpu,
                     name: "CPU %",
                     type: "scatter",
                     line: { color: "#f97316" },
                  },
                  {
                     x: performanceData.time,
                     y: performanceData.memory,
                     name: "Memoria %",
                     type: "scatter",
                     line: { color: "#8b5cf6" },
                  },
               ],
               {
                  plot_bgcolor: "#0f0f23",
                  paper_bgcolor: "#0f0f23",
                  font: { color: "#cccccc" },
                  showlegend: true,
                  xaxis: { showgrid: false, color: "#666" },
                  yaxis: { showgrid: true, gridcolor: "#333", range: [0, 100] },
               },
               { displayModeBar: false }
            );

            if (metrics.network_io) {
               networkData.time.push(time);
               networkData.bytesIn.push(metrics.network_io.bytes_recv);
               networkData.bytesOut.push(metrics.network_io.bytes_sent);

               if (networkData.time.length > 50) {
                  networkData.time.shift();
                  networkData.bytesIn.shift();
                  networkData.bytesOut.shift();
               }

               Plotly.react(
                  "networkChart",
                  [
                     {
                        x: networkData.time,
                        y: networkData.bytesIn,
                        name: "Bytes In",
                        type: "scatter",
                        line: { color: "#4ade80" },
                     },
                     {
                        x: networkData.time,
                        y: networkData.bytesOut,
                        name: "Bytes Out",
                        type: "scatter",
                        line: { color: "#06b6d4" },
                     },
                  ],
                  {
                     plot_bgcolor: "#0f0f23",
                     paper_bgcolor: "#0f0f23",
                     font: { color: "#cccccc" },
                     showlegend: true,
                     xaxis: { showgrid: false, color: "#666" },
                     yaxis: { showgrid: true, gridcolor: "#333" },
                  },
                  { displayModeBar: false }
               );
            }
         }

         function addEventToLog(source, details, eventType = "info") {
            const log = document.getElementById("eventLog");
            const timestamp = new Date().toLocaleTimeString();

            const eventItem = document.createElement("div");
            eventItem.className = "event-item";

            const eventTypeColors = {
               connection: "#4ade80",
               disconnection: "#f87171",
               data_received: "#60a5fa",
               data_sent: "#8b5cf6",
               error: "#f87171",
               system_metric: "#fbbf24",
            };

            eventItem.style.borderLeftColor = eventTypeColors[eventType] || "#4ade80";
            eventItem.innerHTML = `
                <span class="event-time">${timestamp}</span>
                <span class="event-source">${source.toUpperCase()}</span>
                <span class="event-details">${details}</span>
            `;

            log.appendChild(eventItem);

            if (document.getElementById("autoScroll").checked) {
               log.scrollTop = log.scrollHeight;
            }

            while (log.children.length > 500) {
               log.removeChild(log.firstChild);
            }
         }

         function clearEventLog() {
            document.getElementById("eventLog").innerHTML = "";
            addEventToLog("SYSTEM", "Log de eventos limpiado", "info");
         }

         function requestFullHistory() {
            if (socket && socket.readyState === WebSocket.OPEN) {
               socket.send(JSON.stringify({ action: "get_full_history" }));
            }
         }

         function formatBytes(bytes) {
            if (bytes === 0) return "0 B";
            const k = 1024;
            const sizes = ["B", "KB", "MB", "GB"];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + " " + sizes[i];
         }

         window.onload = function () {
            connectWebSocket();

            Plotly.newPlot(
               "performanceChart",
               [],
               {
                  plot_bgcolor: "#0f0f23",
                  paper_bgcolor: "#0f0f23",
                  font: { color: "#cccccc" },
               },
               { displayModeBar: false }
            );

            Plotly.newPlot(
               "networkChart",
               [],
               {
                  plot_bgcolor: "#0f0f23",
                  paper_bgcolor: "#0f0f23",
                  font: { color: "#cccccc" },
               },
               { displayModeBar: false }
            );

            // Actualizar conexiones al redimensionar
            window.addEventListener('resize', () => {
               setTimeout(calculateConnectionLines, 100);
            });

            // Inicializar topolog√≠a
            setTimeout(updateTopologyConnections, 500);
         };
      </script>
   </body>
</html>